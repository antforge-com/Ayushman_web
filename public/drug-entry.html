
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ayurvedic Drug Entry</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif; /* Changed to Inter font for consistency */
      background: #f9fbf9;
      padding: 20px;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      max-width: 850px;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 128, 0, 0.15);
      box-sizing: border-box;
    }

    h2 {
      text-align: center;
      color: #2f7d32;
      margin-bottom: 25px;
      font-size: 2em;
    }

    .section-title {
      display: block;
      margin-top: 25px;
      margin-bottom: 10px;
      font-weight: 600;
      color: #333;
      font-size: 1.1em;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 5px;
    }

    input, textarea {
      width: 100%;
      padding: 12px 14px;
      margin-top: 8px;
      border: 1px solid #d0e8d0;
      border-radius: 8px; /* Slightly more rounded */
      background-color: #f3fdf3;
      font-size: 15px;
      color: #333;
      transition: border-color 0.3s ease, background-color 0.3s ease;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      border-color: #66bb6a;
      outline: none;
      background-color: #ffffff;
      box-shadow: 0 0 5px rgba(102, 187, 106, 0.5);
    }

    .btn {
      display: block;
      width: 100%; /* Give submit button full width */
      margin-top: 30px;
      padding: 15px 25px;
      background-color: #558B2F; /* Matches Flutter button color */
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn:hover {
      background-color: #388E3C; /* Darker green on hover */
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
    }

    .add-btn, .remove-btn {
      padding: 8px 15px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .add-btn {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #81c784;
    }

    .add-btn:hover {
      background-color: #d0e0d1;
    }

    .remove-btn {
      background-color: #ffebee;
      color: #d32f2f;
      border: 1px solid #ef9a9a;
      margin-left: 10px; /* Spacing from other elements */
    }

    .remove-btn:hover {
      background-color: #fce4ec;
    }

    .dynamic-field-group {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #fefefe;
      position: relative;
    }

    .dynamic-field-group .remove-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        margin-left: 0;
        background: none;
        border: none;
        padding: 5px;
        font-size: 12px;
        color: #d32f2f;
        display: flex;
        align-items: center;
        gap: 3px;
    }
    .dynamic-field-group .remove-btn:hover {
        background-color: #f8f8f8;
    }

    .multi-input-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
    }

    .multi-input-row input {
      flex: 1;
      margin-top: 0; /* Override default input margin */
    }

    .add-remove-container {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      align-items: center;
    }

    .category-chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .chip {
      padding: 8px 12px;
      border-radius: 20px;
      border: 1px solid #c5e1a5;
      background-color: #e8f5e9;
      color: #388e3c;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .chip.selected {
      background-color: #c8e6c9;
      border-color: #8bc34a;
      color: #2e7d32;
    }

    .chip:hover {
      background-color: #d0e0d1;
    }

    .chip .icon {
      font-size: 16px;
    }

    #status {
      margin-top: 20px;
      color: #2e7d32;
      font-weight: 600;
      text-align: center;
      min-height: 20px; /* Ensure space for status messages */
    }

    .config-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
      padding-top: 10px;
    }

    .config-section label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }
    .config-section input {
        margin-bottom: 10px;
    }
    .config-section button {
        width: auto;
        padding: 10px 20px;
        font-size: 16px;
        margin-top: 0;
        background-color: #4CAF50;
        box-shadow: none;
    }
    .config-section button:hover {
        background-color: #388e3c;
        transform: none;
        box-shadow: none;
    }

    .error-message {
        color: #d32f2f;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .info-message {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        color: #1565c0;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Ayurvedic Drug Entry Form</h2>

    <div class="config-section">
      <div class="info-message" id="apiKeyMessage">
        Please enter and save your Firebase API Key to enable form submission.
      </div>
      <label for="apiKey">Firebase API Key:</label>
      <input type="text" id="apiKey" placeholder="Enter your Firebase API Key" autocomplete="off" />
      <button class="btn" onclick="saveApiKey()">Save API Key</button>
    </div>

    <form id="drugForm">
      <label class="section-title" for="drugName">Drug Name:</label>
      <input type="text" id="drugName" required>

      <label class="section-title" for="drugDetails">Drug Details:</label>
      <textarea id="drugDetails" rows="5" placeholder="Provide basic details about the drug..."></textarea>

      <label class="section-title">Categories:</label>
      <div id="categoriesContainer" class="category-chips-container">
        <!-- Categories will load dynamically here -->
      </div>
      <div style="text-align: right; margin-top: 5px;">
        <button type="button" class="add-btn" onclick="toggleShowAllCategories()">
          <span id="toggleCategoriesText">Show More</span>
        </button>
      </div>

      <div id="customCategoriesSection" style="display: none; margin-top: 15px;">
        <label class="section-title">Custom Categories:</label>
        <div id="customCategoryFields">
          <!-- Custom category input fields will go here -->
        </div>
        <div class="add-remove-container">
          <button type="button" class="add-btn" onclick="addCustomCategoryField()">
            <span class="icon">&#x2795;</span> Add Custom Category
          </button>
          <button type="button" class="remove-btn" id="removeCustomCategoryBtn" style="display: none;" onclick="removeCustomCategoryField()">
            <span class="icon">&#x274C;</span> Remove Last Custom Field
          </button>
        </div>
      </div>

      <label class="section-title">Treatments (Diseases):</label>
      <div id="diseasesContainer">
        <!-- Dynamic disease fields will be added here -->
      </div>
      <div class="add-remove-container">
        <button type="button" class="add-btn" onclick="addDiseaseField()">
          <span class="icon">&#x2795;</span> Add Disease
        </button>
        <button type="button" class="remove-btn" id="removeDiseaseBtn" style="display: none;" onclick="removeDiseaseField()">
          <span class="icon">&#x274C;</span> Remove Last Disease
        </button>
      </div>

      <label class="section-title">Ingredients:</label>
      <div id="ingredientsContainer">
        <!-- Dynamic ingredient fields will be added here -->
      </div>
      <div class="add-remove-container">
        <button type="button" class="add-btn" onclick="addIngredientField()">
          <span class="icon">&#x2795;</span> Add Ingredient
        </button>
        <button type="button" class="remove-btn" id="removeIngredientBtn" style="display: none;" onclick="removeIngredientField()">
          <span class="icon">&#x274C;</span> Remove Last Ingredient
        </button>
      </div>

      <label class="section-title" for="preparation">Preparation:</label>
      <textarea id="preparation" rows="5" placeholder="Describe the method of preparation..."></textarea>

      <label class="section-title" for="anupana">Anupana:</label>
      <textarea id="anupana" rows="5" placeholder="Describe Anupana here..."></textarea>

      <label class="section-title" for="balances">Balances:</label>
      <textarea id="balances" rows="5" placeholder="Describe balances here..."></textarea>

      <label class="section-title" for="uses">Uses:</label>
      <textarea id="uses" rows="5" placeholder="Describe uses here..."></textarea>

      <label class="section-title" for="sideEffects">Side Effects (if any):</label>
      <textarea id="sideEffects" rows="5" placeholder="Enter side effects here..."></textarea>

      <label class="section-title">Custom Fields:</label>
      <div id="anotherFieldsContainer">
        <!-- Dynamic custom fields will be added here -->
      </div>
      <div class="add-remove-container">
        <button type="button" class="add-btn" onclick="addAnotherField()">
          <span class="icon">&#x2795;</span> Add Custom Field
        </button>
        <button type="button" class="remove-btn" id="removeAnotherFieldBtn" style="display: none;" onclick="removeAnotherField()">
          <span class="icon">&#x274C;</span> Remove Last Custom Field
        </button>
      </div>

      <button type="submit" class="btn">Add Drug</button>
    </form>

    <div id="status"></div>
  </div>

  <script>
    // Firebase Configuration and Initialization
    const firebaseConfig = {
      apiKey: localStorage.getItem("firebaseApiKey") || "", // Use a consistent key
      appId: '1:885564236048:web:c17667f9989e0322bb8595',
      messagingSenderId: '885564236048',
      projectId: 'ayushman-bhava-11a4f',
      authDomain: 'ayushman-bhava-11a4f.firebaseapp.com',
      storageBucket: 'ayushman-bhava-11a4f.firebasestorage.app',
      measurementId: 'G-L9SE7MZ2HZ',
    };

    let firebaseApp;
    let db;

    // Default categories, combined from original HTML and Flutter file
    let _allCategories = [
      'Arishta', 'Asava', 'Arka', 'Awaleha', 'Bhasma', 'Capsule',
      'Churna', 'Dhupa', 'Dravaka', 'Ghrita', 'Guggulu', 'Lepa',
      'Kashaya', 'Rasayana', 'Lauha',
    ];
    let _selectedCategories = [];
    let _showAllCategories = false;
    const categoriesToDisplayLimit = 4; // Similar to Flutter's initial display limit

    // Dynamic field storage
    let diseaseFields = []; // Stores objects: {nameInput, descInput}
    let ingredientFields = []; // Stores objects: {nameInput, qtyInput}
    let anotherFields = []; // Stores objects: {nameInput, valueInput}
    let customCategoryFields = []; // Stores objects: {inputElement}

    const apiKeyMessage = document.getElementById("apiKeyMessage");

    // --- Firebase API Key Handling ---
    function saveApiKey() {
      const keyInput = document.getElementById("apiKey");
      const key = keyInput.value.trim();
      if (key) {
        localStorage.setItem("firebaseApiKey", key); // Use a new localStorage key
        firebaseConfig.apiKey = key; // Update config immediately
        initializeFirebase(); // Attempt to initialize Firebase
      } else {
        showStatus("Please enter a valid API Key.", "error");
      }
    }

    function showStatus(message, type = "info") {
      const statusDiv = document.getElementById("status");
      statusDiv.innerText = message;
      statusDiv.className = `status-message ${type}-message`; // Add CSS class
      console.log(`Status (${type}): ${message}`); // Log to console
    }

    // --- Firebase Initialization ---
    function initializeFirebase() {
      if (firebaseApp) {
        console.log("Firebase is already initialized.");
        showStatus("Firebase is already initialized.", "info");
        return;
      }
      if (!firebaseConfig.apiKey) {
        showStatus("Firebase API Key is missing. Please enter it above.", "error");
        apiKeyMessage.style.display = 'block';
        return;
      }
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase successfully initialized, Firestore instance ready.");
        showStatus("Firebase successfully initialized!", "success");
        apiKeyMessage.style.display = 'none'; // Hide message on successful initialization
        fetchAndSetCategories(); // Fetch categories after Firebase is ready
      } catch (e) {
        console.error("Error initializing Firebase:", e);
        showStatus(`Error initializing Firebase: ${e.message}. Check your API Key.`, "error");
        apiKeyMessage.style.display = 'block';
      }
    }

    // --- Category Management ---
    async function fetchAndSetCategories() {
        if (!db) {
            console.warn("Firestore instance not available, cannot fetch categories.");
            return;
        }
        try {
            const fetchedCategoriesSet = new Set(_allCategories); // Start with predefined

            const querySnapshot = await db.collection('drugs').get();
            querySnapshot.forEach(doc => {
                const drugData = doc.data();
                const categories = drugData['categories'];
                if (categories && Array.isArray(categories)) {
                    categories.forEach(cat => {
                        if (typeof cat === 'string') {
                            fetchedCategoriesSet.add(cat);
                        }
                    });
                }
            });

            _allCategories = Array.from(fetchedCategoriesSet).sort();
            renderCategories(); // Re-render categories after fetching
        } catch (e) {
            console.error('Error fetching categories from Firestore:', e);
            showStatus('Failed to load categories.', 'error');
        }
    }

    function renderCategories() {
      const container = document.getElementById("categoriesContainer");
      container.innerHTML = ''; // Clear existing chips

      const categoriesToRender = _showAllCategories
        ? _allCategories
        : _allCategories.slice(0, categoriesToDisplayLimit);

      categoriesToRender.forEach(category => {
        const chip = document.createElement("div");
        chip.className = `chip ${_selectedCategories.includes(category) ? 'selected' : ''}`;
        chip.innerHTML = `<span class="icon">${_selectedCategories.includes(category) ? '&#x2714;' : '&#x2795;'}</span> ${category}`;
        chip.onclick = () => toggleCategory(category);
        container.appendChild(chip);
      });

      // Update "Show More/Less" button text
      document.getElementById("toggleCategoriesText").innerText = _showAllCategories ? 'Show Less' : 'Show More';

      // Show/hide custom categories section
      const customCategoriesSection = document.getElementById("customCategoriesSection");
      if (_showAllCategories) {
          customCategoriesSection.style.display = 'block';
          renderCustomCategoryFields(); // Re-render custom fields if section is visible
      } else {
          customCategoriesSection.style.display = 'none';
          // When hiding, deselect any custom categories that are not in _allCategories
          _selectedCategories = _selectedCategories.filter(cat => _allCategories.includes(cat));
          // If the section is hidden and they are empty, clear custom category fields
          if (customCategoryFields.every(field => field.input.value.trim() === '')) {
            customCategoryFields = [];
            renderCustomCategoryFields(); // Re-render to clear display
          }
      }
    }

    function toggleCategory(category) {
      if (_selectedCategories.includes(category)) {
        _selectedCategories = _selectedCategories.filter(cat => cat !== category);
      } else {
        _selectedCategories.push(category);
      }
      renderCategories(); // Re-render to update chip styles
    }

    function toggleShowAllCategories() {
      _showAllCategories = !_showAllCategories;
      renderCategories();
    }

    function addCustomCategoryField() {
        const container = document.getElementById("customCategoryFields");
        const div = document.createElement("div");
        div.className = "dynamic-field-group";
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "Enter custom category name...";
        input.className = "customCategoryName";
        input.required = true;
        input.oninput = () => {
            // Automatically select/deselect based on input
            const categoryText = input.value.trim();
            if (categoryText) {
                if (!_selectedCategories.includes(categoryText)) {
                    _selectedCategories.push(categoryText);
                }
            } else {
                _selectedCategories = _selectedCategories.filter(cat => cat !== categoryText);
            }
            renderCategories(); // Re-render chips to update selection state
        };

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-btn";
        removeBtn.innerHTML = <span class="icon">&#x274C;</span>;
        removeBtn.onclick = () => {
            const index = customCategoryFields.findIndex(f => f.input === input);
            if (index > -1) {
                const categoryText = input.value.trim();
                _selectedCategories = _selectedCategories.filter(cat => cat !== categoryText);
                customCategoryFields.splice(index, 1);
                renderCustomCategoryFields();
                renderCategories(); // Update main categories display
            }
        };

        div.appendChild(input);
        div.appendChild(removeBtn);
        container.appendChild(div);

        customCategoryFields.push({ input: input, div: div });
        updateRemoveButtonVisibility("removeCustomCategoryBtn", customCategoryFields);
    }

    function removeCustomCategoryField() {
        if (customCategoryFields.length > 0) {
            const lastField = customCategoryFields.pop();
            lastField.div.remove();
            const categoryText = lastField.input.value.trim();
            _selectedCategories = _selectedCategories.filter(cat => cat !== categoryText);
            updateRemoveButtonVisibility("removeCustomCategoryBtn", customCategoryFields);
            renderCategories(); // Update main categories display
        }
    }

    function renderCustomCategoryFields() {
        const container = document.getElementById("customCategoryFields");
        container.innerHTML = ''; // Clear and re-render
        customCategoryFields.forEach(field => container.appendChild(field.div));
        updateRemoveButtonVisibility("removeCustomCategoryBtn", customCategoryFields);
    }

    // --- Dynamic Fields (Diseases, Ingredients, Other Fields) Management ---
    function createFieldGroup(type) {
        const container = document.getElementById(`${type}sContainer`);
        const groupDiv = document.createElement("div");
        groupDiv.className = "dynamic-field-group";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-btn";
        removeBtn.innerHTML = `<span class="icon">&#x274C;</span> Remove`;
        removeBtn.onclick = () => removeDynamicField(type, groupDiv);
        groupDiv.appendChild(removeBtn);

        return { container, groupDiv };
    }

    function removeDynamicField(type, elementToRemove) {
        elementToRemove.remove();
        let fieldArray;
        let removeButtonId;

        if (type === "disease") {
            diseaseFields = diseaseFields.filter(f => f.div !== elementToRemove);
            fieldArray = diseaseFields;
            removeButtonId = "removeDiseaseBtn";
        } else if (type === "ingredient") {
            ingredientFields = ingredientFields.filter(f => f.div !== elementToRemove);
            fieldArray = ingredientFields;
            removeButtonId = "removeIngredientBtn";
        } else if (type === "anotherField") {
            anotherFields = anotherFields.filter(f => f.div !== elementToRemove);
            fieldArray = anotherFields;
            removeButtonId = "removeAnotherFieldBtn";
        }
        updateRemoveButtonVisibility(removeButtonId, fieldArray);
    }

    function updateRemoveButtonVisibility(buttonId, array) {
        const btn = document.getElementById(buttonId);
        if (btn) {
            btn.style.display = array.length > 0 ? "inline-flex" : "none";
        }
    }

    // Disease Field
    function addDiseaseField() {
        const { container, groupDiv } = createFieldGroup("disease");

        const nameLabel = document.createElement("label");
        nameLabel.innerText = "Disease Name:";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "Enter disease name...";
        nameInput.required = true;

        const descLabel = document.createElement("label");
        descLabel.innerText = "Description:";
        const descTextarea = document.createElement("textarea");
        descTextarea.rows = 3;
        descTextarea.placeholder = "Add description...";

        groupDiv.appendChild(nameLabel);
        groupDiv.appendChild(nameInput);
        groupDiv.appendChild(descLabel);
        groupDiv.appendChild(descTextarea);
        container.appendChild(groupDiv);

        diseaseFields.push({ nameInput, descTextarea, div: groupDiv });
        updateRemoveButtonVisibility("removeDiseaseBtn", diseaseFields);
    }

    // Ingredient Field
    function addIngredientField() {
        const { container, groupDiv } = createFieldGroup("ingredient");

        const row = document.createElement("div");
        row.className = "multi-input-row";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "Ingredient Name";
        nameInput.className = "ingredientName";
        nameInput.required = true;

        const qtyInput = document.createElement("input");
        qtyInput.type = "text";
        qtyInput.placeholder = "Quantity (mg)";
        qtyInput.className = "ingredientQty";
        qtyInput.required = true;

        row.appendChild(nameInput);
        row.appendChild(qtyInput);
        groupDiv.appendChild(row);
        container.appendChild(groupDiv);

        ingredientFields.push({ nameInput, qtyInput, div: groupDiv });
        updateRemoveButtonVisibility("removeIngredientBtn", ingredientFields);
    }

    // Other Fields (Custom Key-Value Pairs)
    function addAnotherField() {
        const { container, groupDiv } = createFieldGroup("anotherField");

        const nameLabel = document.createElement("label");
        nameLabel.innerText = "Field Name:";
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "Enter field name...";
        nameInput.required = true;

        const valueLabel = document.createElement("label");
        valueLabel.innerText = "Field Value:";
        const valueInput = document.createElement("textarea");
        valueInput.rows = 3;
        valueInput.placeholder = "Enter field value...";
        valueInput.required = true;

        groupDiv.appendChild(nameLabel);
        groupDiv.appendChild(nameInput);
        groupDiv.appendChild(valueLabel);
        groupDiv.appendChild(valueInput);
        container.appendChild(groupDiv);

        anotherFields.push({ nameInput, valueInput, div: groupDiv });
        updateRemoveButtonVisibility("removeAnotherFieldBtn", anotherFields);
    }

    // --- Form Submission ---
    document.getElementById("drugForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      if (!db) {
        showStatus("Firebase is not initialized. Please ensure the API Key is saved and try again.", "error");
        return;
      }

      const drugName = document.getElementById("drugName").value.trim();
      const drugDetails = document.getElementById("drugDetails").value.trim();
      const preparation = document.getElementById("preparation").value.trim();
      const anupana = document.getElementById("anupana").value.trim();
      const balances = document.getElementById("balances").value.trim();
      const uses = document.getElementById("uses").value.trim();
      const sideEffects = document.getElementById("sideEffects").value.trim();
      const extraInformation = ''; // Not explicitly in Flutter, kept empty for consistency

      // Validate required fields
      if (!drugName) {
          showStatus("Drug Name is required.", "error");
          return;
      }

      // Collect diseases
      const diseases = diseaseFields.map(field => ({
          name: field.nameInput.value.trim(),
          description: field.descTextarea.value.trim()
      })).filter(d => d.name || d.description); // Only include if name or description exists

      // Collect ingredients
      const ingredients = ingredientFields.map(field => ({
          name: field.nameInput.value.trim(),
          mg: field.qtyInput.value.trim()
      })).filter(i => i.name || i.mg); // Only include if name or quantity exists

      // Collect custom fields
      const anotherFieldsData = anotherFields.map(field => ({
          fieldName: field.nameInput.value.trim(),
          fieldValue: field.valueInput.value.trim()
      })).filter(f => f.fieldName || f.fieldValue); // Only include if name or value exists

      // Collect all selected categories, including custom ones from input fields
      const finalCategories = [..._selectedCategories];
      customCategoryFields.forEach(field => {
          const customCatText = field.input.value.trim();
          if (customCatText && !finalCategories.includes(customCatText)) {
              finalCategories.push(customCatText);
          }
      });


      const drugData = {
        drugName: drugName,
        drugDetails: drugDetails,
        categories: finalCategories,
        diseases: diseases,
        ingredients: ingredients,
        preparation: preparation,
        anupana: anupana,
        balances: balances,
        uses: uses,
        sideEffects: sideEffects,
        extraInformation: extraInformation, // Included for consistency
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        anotherFields: anotherFieldsData,
      };

      try {
        console.log("Attempting to add data to Firestore:", drugData);
        await db.collection("drugs").add(drugData);
        showStatus("Drug details successfully submitted!", "success");
        document.getElementById("drugForm").reset();
        // Clear dynamic fields
        clearDynamicFields();
        // Re-fetch categories to include any new custom ones added
        await fetchAndSetCategories();
        _selectedCategories = []; // Clear selected categories for new entry
        renderCategories(); // Re-render categories to reflect changes
      } catch (err) {
        console.error("Error submitting drug:", err);
        showStatus(`Failed to submit drug: ${err.message}. Please check console and Firebase security rules.`, "error");
      }
    });

    function clearDynamicFields() {
        // Clear and remove disease fields
        diseaseFields.forEach(f => f.div.remove());
        diseaseFields = [];
        updateRemoveButtonVisibility("removeDiseaseBtn", diseaseFields);

        // Clear and remove ingredient fields
        ingredientFields.forEach(f => f.div.remove());
        ingredientFields = [];
        updateRemoveButtonVisibility("removeIngredientBtn", ingredientFields);

        // Clear and remove another fields
        anotherFields.forEach(f => f.div.remove());
        anotherFields = [];
        updateRemoveButtonVisibility("removeAnotherFieldBtn", anotherFields);

        // Clear and remove custom category fields
        customCategoryFields.forEach(f => f.div.remove());
        customCategoryFields = [];
        updateRemoveButtonVisibility("removeCustomCategoryBtn", customCategoryFields);
        _showAllCategories = false; // Collapse custom categories section
        document.getElementById("customCategoriesSection").style.display = 'none';
    }


    // --- Onload Initialization ---
    window.onload = () => {
      const savedApiKey = localStorage.getItem("firebaseApiKey"); 
      const apiKeyInput = document.getElementById("apiKey");

      if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
        firebaseConfig.apiKey = savedApiKey;
        initializeFirebase();
      } else {
        showStatus("Please enter your Firebase API Key to get started.", "info");
        apiKeyMessage.style.display = 'block';
      }
      renderCategories(); // Render initial categories even before Firebase initialization
    };
  </script>
</body>
</html>
